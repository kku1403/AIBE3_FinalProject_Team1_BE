name: be-ci

on:
  pull_request:
    paths:
      - "backend/**"
      - ".github/workflows/be-ci.yml"
  push:
    branches: ["dev", "feat/**"]
    paths:
      - "backend/**"
      - ".github/workflows/be-ci.yml"

permissions:
  contents: read

concurrency:
  group: be-ci-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    working-directory: backend

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    env:
      CI: true
      SPRING_PROFILES_ACTIVE: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # gradle wrapper 보안 검증
      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      # Gradle 실행 JVM(JDK 24)
      - name: Setup Java (Gradle JVM = 24)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "24"
          cache: gradle

      # 코드 toolchain용 JDK 25 미리 설치
      - name: Provision Java 25 for toolchain
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-read-only: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork }}

      # .env 파일 생성
      - name: Create .env file
        run: |
          echo "${{ secrets.DOT_ENV_CI }}" > .env
          echo "✅ .env file created"

      # Docker Compose로 MariaDB & Redis 시작
      - name: Start MariaDB and Redis
        run: |
          docker compose up -d mariadb redis
          echo "⏳ Waiting for services to be ready..."
          sleep 10

      # 서비스 헬스체크
      - name: Wait for MariaDB
        run: |
          until docker exec chwimeet-mariadb mariadb-admin ping -h localhost -uroot -p${{ secrets.DB_PASSWORD }} --silent; do
            echo "Waiting for MariaDB..."
            sleep 2
          done
          echo "✅ MariaDB is ready"

      - name: Wait for Redis
        run: |
          until docker exec chwimeet-redis redis-cli -a ${{ secrets.REDIS_PASSWORD }} ping | grep -q PONG; do
            echo "Waiting for Redis..."
            sleep 2
          done
          echo "✅ Redis is ready"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Print versions
        run: |
          ./gradlew --version
          java -version

      - name: Initialize database schema with JPA entities
        env:
          SPRING__DATASOURCE__URL: jdbc:mariadb://localhost:3306/chwimeet?currentSchema=chwimeet
          SPRING__DATASOURCE__USERNAME: root
          SPRING__DATASOURCE__PASSWORD: ${{ secrets.DB_PASSWORD }}
          SPRING__JPA__HIBERNATE__DDL_AUTO: create
          SPRING__JPA__PROPERTIES__HIBERNATE__HBM2DDL__SCHEMA_GENERATION__SCRIPT__APPEND: false
        run: |
          echo "=== Generating schema from JPA entities ==="
          
          # Hibernate SchemaExport를 사용해서 DDL 생성
          cat > schema-gen.gradle.kts << 'EOF'
          tasks.register("generateSchema") {
              doLast {
                  // Hibernate SchemaExport 실행
                  val configuration = org.hibernate.cfg.Configuration()
          
                  // Entity 클래스들을 스캔
                  val sessionFactory = configuration.buildSessionFactory()
          
                  val schemaExport = org.hibernate.tool.hbm2ddl.SchemaExport(configuration)
                  schemaExport.setOutputFile("schema.sql")
                  schemaExport.create(true, false)
              }
          }
          EOF

      - name: Generate JOOQ sources
        env:
          SPRING__DATASOURCE__URL: jdbc:mariadb://localhost:3306/chwimeet?currentSchema=chwimeet
          SPRING__DATASOURCE__USERNAME: root
          SPRING__DATASOURCE__PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "=== Starting JOOQ Generation ==="
          
          # 먼저 테이블 확인
          echo "=== Tables available for JOOQ ==="
          docker exec chwimeet-mariadb mariadb -uroot -p${{ secrets.DB_PASSWORD }} -e "USE chwimeet; SHOW TABLES;"
          
          echo "=== Running JOOQ generation ==="
          ./gradlew generateJooq --info --stacktrace --no-daemon 2>&1 | tee jooq-generation.log
          echo "=== JOOQ Generation Complete ==="
          
          # 결과 확인
          if [ -d "build/generated-src/jooq/main" ]; then
            echo "✅ JOOQ directory exists"
          
            # 생성된 파일 확인
            if [ -d "build/generated-src/jooq/main/com/back/jooq/tables" ]; then
              echo "=== Generated JOOQ tables ==="
              ls -la build/generated-src/jooq/main/com/back/jooq/tables/ || echo "Tables directory exists but is empty"
            else
              echo "❌ Tables directory not found in JOOQ output"
            fi
          
            # 전체 구조 확인
            echo "=== Full JOOQ directory structure ==="
            find build/generated-src/jooq/main -type f || echo "No files found"
          else
            echo "❌ JOOQ directory NOT found"
            echo "=== Checking what was generated ==="
            ls -laR build/generated-src/ 2>/dev/null || echo "generated-src directory doesn't exist"
          
            echo "=== JOOQ Generation Log (last 50 lines) ==="
            tail -50 jooq-generation.log
            exit 1
          fi

      # 테스트 + 커버리지
      - name: Run tests (JUnit5) with coverage
        run: ./gradlew test jacocoTestReport --info --stacktrace --no-daemon

      # 빌드(테스트/커버리지 재실행 방지)
      - name: Assemble (no tests)
        run: ./gradlew assemble -x test -x jacocoTestReport --no-daemon

      # 테스트 결과 업로드
      - name: Upload test results (JUnit XML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: backend/build/test-results/test
          if-no-files-found: ignore
          retention-days: 3

      # 테스트 HTML 리포트
      - name: Upload test report (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report-html
          path: backend/build/reports/tests/test
          if-no-files-found: ignore

      # 커버리지 리포트 업로드
      - name: Upload coverage report (JaCoCo HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: backend/build/reports/jacoco/test/html
          if-no-files-found: ignore
          retention-days: 3

      # Docker Compose 정리
      - name: Stop Docker services
        if: always()
        run: docker compose down -v